name: Code CI

on:
  push:
    paths-ignore:
      - "**.md"
  pull_request:
    paths-ignore:
      - "**.md"

concurrency:
  group: general-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

jobs:
  code-formatting:
    runs-on: ubuntu-20.04
    timeout-minutes: 30
    env:
      VFLAGS: -cc tcc
    steps:
    - name: Install V
      uses: vlang/setup-v@v1
      with:
        check-latest: true

    - uses: actions/checkout@v2
      with:
        path: vab

    - name: Test code formatting
      run: |
        cd vab
        v test-fmt

    - name: Build vab
      run: v -g vab/vab.v

    - name: Test clean vab code
      run: |
        vab/vab test-cleancode vab

  ubuntu-latest-bootstrap:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      VAB_FLAGS: -v 3 --api 30 --build-tools 29.0.0
    steps:
    - name: Install V
      uses: vlang/setup-v@v1
      with:
        check-latest: true

    - uses: actions/checkout@v2
      with:
        path: vab

    - name: Run tests
      run: v test vab

    - name: Build vab with -prod
      run: v -prod vab/vab.v

    - name: Build vab
      run: v -g vab/vab.v

    - name: Run 'vab --help'
      run: vab/vab --help

    - name: Ruin Android environment on purpose
      run: |
        sudo rm -fr /usr/local/lib/android

    - name: Run 'vab doctor'
      run: |
        vab/vab doctor

    - name: Run 'vab install auto'
      run: |
        export ANDROID_SDK_ROOT="" # These are set in the CI by default
        export ANDROID_HOME=""
        export ANDROID_NDK_ROOT=""
        vab/vab install auto

    - name: Run vab doctor
      run: |
        vab/vab doctor

    - name: Setup env
      run: |
        mkdir apks

    - name: Build APK (Default) examples/sokol/particles
      run: |
        vab/vab examples/sokol/particles -o apks/particles.apk


  ubuntu-latest-install:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      VAB_FLAGS: -v 3 --api 30 --build-tools 29.0.0
    steps:
    - name: Install V
      uses: vlang/setup-v@v1
      with:
        check-latest: true

    - uses: actions/checkout@v2
      with:
        path: vab

    - name: Run tests
      run: v test vab

    - name: Build vab with -prod
      run: v -prod vab/vab.v

    - name: Build vab
      run: v -g vab/vab.v

    - name: Run 'vab --help'
      run: vab/vab --help

    - name: Ruin Android environment on purpose
      run: |
        sudo rm -fr "$ANDROID_SDK_ROOT/platforms"

    - name: Run 'vab doctor'
      run: |
        vab/vab doctor

    - name: Run 'vab install "platforms;android-21"'
      run: |
        vab/vab install "platforms;android-21"

    - name: Run vab doctor
      run: |
        vab/vab doctor

    - name: Setup env
      run: |
        mkdir apks

    - name: Build APK (Default) examples/sokol/particles
      run: |
        vab/vab examples/sokol/particles -o apks/particles.apk

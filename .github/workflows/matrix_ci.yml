name: Build APK/AAB CI

on:
  push:
    paths-ignore:
      - "**.md"
  pull_request:
    paths-ignore:
      - "**.md"

jobs:
  build-examples-as-apk-aab:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        #os: [macos-latest, macOS-10.15, ubuntu-latest, ubuntu-18.04]
        os: [ubuntu-latest, ubuntu-18.04]
        java-jdk: [8, 11, 12]
        v-example: ["sokol/particles", "2048" "fireworks"]
    timeout-minutes: 30
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-java@v2
        with:
          distribution: 'adopt'
          java-version: ${{ matrix.java-jdk }}

    - name: Checkout V
      uses: actions/checkout@v2
      with:
        repository: vlang/v
    - uses: actions/checkout@v2
      with:
        path: vab
    - name: Build local v
      run: make -j2

    - name: Run tests
      run: ./v test vab

    - name: Build vab with -prod
      run: ./v -prod -g vab/vab.v

    - name: Build vab
      run: ./v -g vab/vab.v

    - name: Run vab --help
      run: vab/vab --help

    - name: Setup env
      run: |
        mkdir -p apks/java-${{ matrix.java-jdk }}/${{ matrix.v-example }}
        mkdir -p aabs/java-${{ matrix.java-jdk }}/${{ matrix.v-example }}

    - name: Run vab doctor
      run: |
        export VEXE=./v
        vab/vab doctor

    - name: Build APK (Java ${{ matrix.java-jdk }}) ${{ matrix.v-example }}
      run: |
        export VEXE=./v
        vab/vab -v 3 examples/${{ matrix.v-example }} -o apks/java-${{ matrix.java-jdk }}/${{ matrix.v-example }}/app-${{ matrix.v-example }}-package.apk

    # AAB Testing
    - name: Install AAB dependencies
      run: |
        export VEXE=./v
        vab/vab install bundletool
        vab/vab install aapt2

    - name: Build AAB (Java ${{ matrix.java-jdk }}) ${{ matrix.v-example }}
      run: |
        export VEXE=./v
        vab/vab --package aab -v 3 examples/${{ matrix.v-example }} -o apks/java-${{ matrix.java-jdk }}/${{ matrix.v-example }}/app-${{ matrix.v-example }}-package.aab
